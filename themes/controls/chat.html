
<script type="text/javascript">
    var lastMessageId = -1;
    var chatTimeOut = -1;
    var blinkTimeOut = -1;
    var alertChat = {if $currentUser->SoundChat==0}false{else}true{/if};
    
{literal}
    function sendMessage() {
    	var message = trim($("#tbChatMessage").val());
    	if(message != '')
    	{
    		$("#tbChatMessage").val('');
    		$.ajax({
                type: "POST",
                url: "/response/chatresponse.php",
                data: "action=writemessage&message=" + message,
                success: function (result) {
                    getMessages(true);                    
                }
            });	
    	}        
    }
        
    function getMessages(self) {
    	if(self == undefined)
    	{
    		self = false;
    	}
        $.ajax({
            type: "POST",
            url: "/response/chatresponse.php",
            data: "action=getmessages&lastid=" + lastMessageId,
            success: function (result) {
                clearTimeout(chatTimeOut);

                var res = JSON.parse(result);

                if (res['lastid'] != 'nomessages' && res['lastid'] != lastMessageId) {

                    if (lastMessageId == -1) {
                        $("#divChat div.messages").html(res['html']);
                    }
                    else {
                        $("#divChat div.messages").append(res['html']);
                        if(!self)
                        {
                        	alertSound();
                            blinkChat();	
                        }                        
                    }
                                        
                    $("#divChat div.messages").scrollTop(100000);

                    lastMessageId = res['lastid'];
                }

                chatTimeOut = setTimeout(function () { getMessages(); }, 10000);
            }
        });
    }
    
    function alertSound()
    {
    	if(alertChat)
    	{
    		$.playSound('http://vag44.net/sound/horn.mp3');
    	}    	    	
    }
    
    
    function blinkChat() {
    	clearTimeout(blinkTimeOut);
    	var visible = $("#divChat div.content").is(':visible'); 
        if(visible)
        {
        	$("#divChat div.header").toggleClass('highlight');
        	if($("#divChat div.header").hasClass('highlight'))
        	{
        		blinkTimeOut = setTimeout(function () { blinkChat() }, 300);	
        	}        	
        }
        else        	
        {
        	$("#divChat div.header").toggleClass('highlight');
        	blinkTimeOut = setTimeout(function () { blinkChat() }, $("#divChat div.header").hasClass('highlight') ? 300:10000);
        }
    }
    

    function tbMessageKeyUp(e) {
        if (e.keyCode == 13) {
            sendMessage();
        }
    }

    function toggleChat() {
        //$("#divChat div.content").toggleClass('hidden');

        var visible = $("#divChat div.content").is(':visible'); 
        if(visible)
        {
        	$("#divChat div.content").hide();
        }
        else
        {
        	$("#divChat div.content").show();
        	$("#divChat div.messages").scrollTop(100000);
        }
        visible = !visible;
    
        $("#divChat div.header button.close i").attr("class", visible ? 'icon-chevron-down' : 'icon-chevron-up' );
        
        $.ajax({
            type: "POST",
            url: "/response/chatresponse.php",
            data: "action=setvisible&newvalue=" + (visible ? '1' : '0'),
            success: function (result) {  
            	
            }
        });
    }
    
    function toggleSound()
    {
    	var enabled = $("#divChat button.mute i").hasClass('icon-volume-up');
    	if(enabled)
    	{
    		$("#divChat button.mute i").removeClass('icon-volume-up');
    		$("#divChat button.mute i").addClass('icon-volume-off');
    	}
    	else
    	{
    		$("#divChat button.mute i").removeClass('icon-volume-off');
    		$("#divChat button.mute i").addClass('icon-volume-up');    		
    	}    
    	enabled = !enabled;
    	alertChat = enabled;
    	$.ajax({
            type: "POST",
            url: "/response/chatresponse.php",
            data: "action=setsound&newvalue=" + (enabled ? '1' : '0'),
            success: function (result) {  
            	
            }
        });
    }    
    
    function toggleCompact()
    {
    	var enabled = $("#divChat button.compact i").hasClass('icon-align-justify');
    	if(enabled)
    	{
    		$("#divChat button.compact i").removeClass('icon-align-justify');
    		$("#divChat button.compact i").addClass('icon-user');
    	}
    	else
    	{
    		$("#divChat button.compact i").removeClass('icon-user');
    		$("#divChat button.compact i").addClass('icon-align-justify');    		
    	}    
    	enabled = !enabled;
    	alertChat = enabled;
    	$.ajax({
            type: "POST",
            url: "/response/chatresponse.php",
            data: "action=setcompact&newvalue=" + (enabled ? '1' : '0'),
            success: function (result) {
            	lastMessageId = -1;
            	getMessages();
            }
        });    	
    }

    getMessages();        
</script>
{/literal}


<div id='chatAlert' class='hidden'></div>
<div id="divChat" class="whiteform chat">
    <div class="header">Уютненький чатик 
        <button class="btn btn-small pull-right close" onclick="toggleChat();">
            <i class='icon-chevron-{if $currentUser->ShowChat==0}up{else}down{/if}'></i>
        </button>
    </div>
    <div class="content {if $currentUser->ShowChat==0}hidden{/if}">
        <div class="messages">
            <div class="progress progress-striped active">
                <div class="bar" style="width: 100%;">Загружаем...</div>
            </div>
        </div>
        <div class="write">
            <div class="input-append">
              <input class="message" id="tbChatMessage" type="text" onkeyup="tbMessageKeyUp(event);">
              <div class="btn-group">
                <button class="btn btn-primary" onclick="sendMessage();">
                  Тыц                  
                </button>                
              </div>
            </div>            
        </div>
        <div>
        	<button class='btn mute' onclick='toggleSound();'>
        		<i class='icon-volume-{if $currentUser->SoundChat==1}up{else}off{/if}'></i>        		
        	 </button>
        	 <button class='btn compact' onclick='toggleCompact();'>
        	 	<i class='{if $currentUser->CompactChat==1}icon-align-justify{else}icon-user{/if}'></i>
        	 </button>
        </div>
    </div>
</div>

<script>
{literal}
	if($(window).height()<550)
	{
		$("#divChat div.messages").css('height', $(window).height()-270) ;
	}
{/literal}	
</script>